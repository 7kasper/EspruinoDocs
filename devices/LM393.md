<!--- Copyright (c) 2013 Spence Konde. See the file LICENSE for copying permission. -->
LM339/393 Comparator (set watch on analog voltage)
=====================

* KEYWORDS: MOSFET,Transitor

One limitation of most microcontrollers, including those used in the Espruino board, is that there is no way to set an watch/interrupt based on the analog value of a pin. Without external components, all you can do is periodically poll the pin with analogRead(). This means that the Espruino must wake periodically if in sleep mode to save power, and if the Espruino must respond within a few seconds, the polling would need to be so frequent that sleep could not be used at all. 

Luckily, there is a readily available and inexpensive solution in the form of LM393/339 dual/quad comparators. Each of the 2 or 4 comparators on these parts has a non-inverting input (+), an inverting input (-), and an output. If the non-inverting input is lower than the inverting input, the output will be pulled low. Now, if you want to trigger a callback when the voltage goes above a certain voltage, you need only connect one of the inputs to a reference voltage, and the output to a pin on the Espruino, and setWatch() on that. 

If the voltage of interest is between 0 and 3.3v, you can generate a voltage reference using the Espruino's DAC. If you need a higher voltage, you'll need to get it through other means. The LM339/393 can be used with voltages up to 30v, but when comparing higher voltages, note that at least one of the inputs must be within the "common mode voltage range", between 0V and Vcc-1.5v, in order to provide correct results. 


Connections
----------------------

The connections are simple:

| Pin  | Connect to  |
|------|-------------|
| Vcc  | BAT (not 3.3v - see above) |
| Gnd  | Gnd |
| Out  | Any IO pin |
| In+  | Input, non-inverting |
| In-  | Input, inverting |

(LM393)[LM393 soldered into the SMD prototyping area on an Espruino]

The LM393 can be soldered into the SMD prototyping area on the Espruino.


Example
--------------------

Here, a light-dependent resistor is used as the input to both comparators on an LM393. See the [LDR](LDR) page for connection details. 

| Pin  | Connect to  |
|------|-------------|
| Vcc  | BAT |
| Gnd  | Gnd |
| Out1 | A2 |
| In+1 | LDR |
| In-1 | A4 |
| Out1 | A2 |
| In+1 | LDR |
| In-1 | A5 |
| LDR  | Both non-inverting inputs, A6 |


```

var watch1;
var watch2;
var x;
pinMode(A2,"input_pullup");
pinMode(A3,"input_pullup");

function start() {
  x = analogRead(A6);
  analogWrite(A4,Math.max(x-0.1,0));
  analogWrite(A5,Math.min(1,x+0.1));
  watch1=setWatch(function (a){clearWatch(watch2);setTimeout("onWatch(1)",1000);},A2); //clear the other watch
  watch2=setWatch(function (a){clearWatch(watch1);setTimeout("onWatch(0)",1000);},A3); //timeout allows the value to stabilize, since LDRs do not instantly respond to changes
}

function onWatch(a) {
 var s=a?"brighter":"darker";
 var n=analogRead(A6);
 console.log("Light level changed - it got "+s+". Old: "+x+"  New: "+n+". Resetting watches now");
 start();
}

```
